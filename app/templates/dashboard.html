{% extends "base.html" %}

{% block title %}Trading Bot Dashboard{% endblock %}

{% block extra_head %}
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: Arial, sans-serif;
    background: #1a1a1a;
    color: white;
    padding: 10px;
}
.container { max-width: 1400px; margin: 0 auto; }
.header { background: #2d2d2d; padding: 15px; border-radius: 10px; margin-bottom: 15px; display: flex; flex-direction: column; gap: 15px; }
.header-top { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
.header-controls { display: flex; align-items: center; flex-wrap: wrap; gap: 10px; }
.panel { background: #2d2d2d; padding: 20px; border-radius: 10px; margin-bottom: 15px; }
.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 15px; }
.stat { background: #3d3d3d; padding: 15px; border-radius: 8px; text-align: center; }
.stat-value { font-size: 22px; font-weight: bold; color: #4CAF50; }
.stat.negative .stat-value { color: #f44336; }
.btn {
    background: #4CAF50; color: white; border: none; padding: 10px 18px; border-radius: 6px;
    cursor: pointer; font-size: 14px; transition: 0.2s;
}
.btn:hover { background: #45a049; }
.btn.stop { background: #f44336; }
.btn.stop:hover { background: #da190b; }
.btn.warning { background: #ff9800; }
.btn.small { padding: 6px 12px; font-size: 12px; }
.wallet-item {
    background: #3d3d3d; padding: 14px; margin: 6px 0; border-radius: 6px;
    display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;
}
.wallet-actions button { margin: 2px; }
.modal {
    display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.85); z-index: 1000; align-items: center; justify-content: center;
}
.modal-content {
    background: #2d2d2d; padding: 25px; border-radius: 12px; width: 90%; max-width: 420px;
}
input, select {
    width: 100%; padding: 10px; margin: 8px 0; background: #333; border: 1px solid #555;
    color: white; border-radius: 6px; font-size: 14px;
}
#output {
    background: #111; padding: 12px; border-radius: 8px; height: 180px; overflow-y: auto;
    font-family: monospace; font-size: 11px; white-space: pre-wrap; color: #0f0;
}
.mode-banner {
    background: #ff9800; color: black; padding: 6px 12px; border-radius: 6px; font-weight: bold; font-size: 13px;
}
</style>
{% endblock %}

{% block content %}
<div class="container">
<div class="header">
    <div class="header-top">
        <h1>Polymarket Copytrader</h1>
        <div class="header-controls">
            <div class="notification-bell" onclick="toggleNotifications()">
                <i class="fas fa-bell"></i>
                <span class="notification-badge" id="notificationCount">0</span>
            </div>

            <!-- BOT CONTROL -->
            <form action="/api/settings/bot" method="POST" style="display:flex; gap:8px; align-items:center;">
                <select name="bot_status" onchange="this.form.submit()" style="padding:8px;">
                    <option value="RUNNING" {% if s.bot_status == "RUNNING" %}selected{% endif %}>RUNNING</option>
                    <option value="STOPPED" {% if s.bot_status == "STOPPED" %}selected{% endif %}>STOPPED</option>
                </select>
                <select name="trading_mode" onchange="this.form.submit()" style="padding:8px;">
                    <option value="TEST" {% if s.trading_mode == "TEST" %}selected{% endif %}>TEST</option>
                    <option value="LIVE" {% if s.trading_mode == "LIVE" %}selected{% endif %}>LIVE</option>
                </select>
                <label style="display:flex; align-items:center; gap:6px; color:#fff;">
                    <input type="checkbox" name="dry_run_enabled" onchange="this.form.submit()" {% if s.dry_run_enabled %}checked{% endif %}>
                    DRY RUN
                </label>
            </form>

            <span class="mode-banner">
                MODE: {{ s.trading_mode }} {% if s.dry_run_enabled %}[DRY RUN]{% endif %}
            </span>
        </div>
    </div>
</div>

<!-- TABS -->
<div class="tab-container">
    <button class="tab active" data-tab="overview">Overview</button>
    <button class="tab" data-tab="wallets">Wallets</button>
    <button class="tab" data-tab="risk">Risk & Balance</button>
    <button class="tab" data-tab="settings">Settings</button>
</div>

<!-- OVERVIEW -->
<div id="overview-tab" class="tab-content active">
    <div class="panel">
        <h3>Performance</h3>
        <div class="stats-grid">
            <div class="stat"><div class="stat-value">{{ stats.total_trades or 0 }}</div><div>Total Trades</div></div>
            <div class="stat"><div class="stat-value">${{ "%.2f"|format(stats.total_pnl or 0) }}</div><div>Total P&L</div></div>
            <div class="stat"><div class="stat-value">{{ active_wallets_count }}</div><div>Active Wallets</div></div>
            <div class="stat"><div class="stat-value">{{ s.copy_percentage }}%</div><div>Copy %</div></div>
        </div>
    </div>

    <div class="panel">
        <h3>Recent Activity</h3>
        <div id="output">Bot ready. Add a whale wallet to begin.</div>
    </div>
</div>

<!-- WALLETS TAB -->
<div id="wallets-tab" class="tab-content">
    <div class="panel">
        <h3>Leader Wallets</h3>
        <button class="btn" onclick="document.getElementById('addWalletModal').style.display='flex'">Add Wallet</button>
        <div class="wallet-list">
            {% for wallet in leader_wallets %}
            <div class="wallet-item">
                <div>
                    <div class="wallet-nickname">{{ wallet.nickname or "Unnamed" }}</div>
                    <div class="wallet-address">{{ wallet.address }}</div>
                </div>
                <div class="wallet-actions">
                    <form action="/api/wallets/toggle/{{ wallet.id }}" method="POST" style="display:inline;">
                        <button type="submit" class="btn small {{ 'stop' if wallet.is_active else '' }}">
                            {{ "Pause" if wallet.is_active else "Resume" }}
                        </button>
                    </form>
                    <form action="/api/wallets/remove/{{ wallet.id }}" method="POST" style="display:inline;">
                        <button type="submit" class="btn small stop" onclick="return confirm('Remove wallet?')">Remove</button>
                    </form>
                </div>
            </div>
            {% else %}
            <div class="wallet-item">No wallets added yet.</div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- RISK & BALANCE -->
<div id="risk-tab" class="tab-content">
    <div class="panel">
        <h3>Balance & Risk</h3>
        <form action="/api/settings/balance" method="POST">
            <label>Portfolio Value ($)</label>
            <input type="number" name="portfolio_value" value="{{ s.portfolio_value }}" step="0.01" required>
            
            <label>Available Cash ($)</label>
            <input type="number" name="available_cash" value="{{ s.available_cash }}" step="0.01" required>
            
            <label>Copy % per Trade</label>
            <input type="range" name="copy_percentage" min="1" max="100" value="{{ s.copy_percentage }}">
            <span>{{ s.copy_percentage }}%</span>
            
            <button type="submit" class="btn" style="margin-top:15px;">Save All Settings</button>
        </form>
    </div>
</div>

<!-- SETTINGS TAB -->
<div id="settings-tab" class="tab-content">
    <div class="panel">
        <h3>Advanced Settings</h3>
        <p>Coming soon: trade cooldown, daily loss limit, etc.</p>
    </div>
</div>

<!-- ADD WALLET MODAL -->
<div id="addWalletModal" class="modal">
    <div class="modal-content">
        <h3>Add Whale Wallet</h3>
        <form action="/api/wallets/add" method="POST">
            <input type="text" name="nickname" placeholder="Nickname (optional)">
            <input type="text" name="address" placeholder="0x..." required>
            <div style="margin-top:15px; text-align:right;">
                <button type="button" class="btn stop" onclick="document.getElementById('addWalletModal').style.display='none'">Cancel</button>
                <button type="submit" class="btn">Add Wallet</button>
            </div>
        </form>
    </div>
</div>

<!-- NOTIFICATIONS PANEL -->
<div class="notifications-panel" id="notificationsPanel" style="display:none;">
    <div class="notifications-header">
        <h3>Notifications</h3>
        <button class="btn-clear" onclick="clearAllNotifications()">Clear All</button>
    </div>
    <div class="notifications-body" id="notificationsList">
        <div class="no-notifications">No notifications</div>
    </div>
</div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
const socket = io();

// Real-time trade alerts
socket.on("new_trade", (data) => {
    const time = new Date().toLocaleTimeString();
    document.getElementById("output").textContent += `\n[${time}] ${data.wallet}: ${data.outcome} $${data.amount.toFixed(2)}`;
    document.getElementById("output").scrollTop = document.getElementById("output").scrollHeight;
    addNotification("Trade Copied", `${data.wallet} â†’ ${data.outcome} $${data.amount.toFixed(2)}`, "success");
});

// Notification system
let notifications = JSON.parse(localStorage.getItem("notifications") || "[]");
function addNotification(title, msg, type = "info") {
    notifications.unshift({title, msg, type, time: new Date()});
    if (notifications.length > 50) notifications.pop();
    localStorage.setItem("notifications", JSON.stringify(notifications));
    renderNotifications();
}
function renderNotifications() {
    const list = document.getElementById("notificationsList");
    if (notifications.length === 0) {
        list.innerHTML = '<div class="no-notifications">No notifications</div>';
        document.getElementById("notificationCount").textContent = "0";
        return;
    }
    document.getElementById("notificationCount").textContent = notifications.length;
    list.innerHTML = notifications.map(n => `
        <div class="notification-item">
            <div class="notification-title">${n.title}</div>
            <div class="notification-message">${n.msg}</div>
            <div class="notification-time">${n.time.toLocaleTimeString()}</div>
        </div>
    `).join("");
}
function clearAllNotifications() {
    notifications = [];
    localStorage.setItem("notifications", "[]");
    renderNotifications();
}
function toggleNotifications() {
    const panel = document.getElementById("notificationsPanel");
    panel.style.display = panel.style.display === "block" ? "none" : "block";
}
renderNotifications();

// Tab system
document.querySelectorAll(".tab").forEach(tab => {
    tab.addEventListener("click", () => {
        document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
        document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));
        tab.classList.add("active");
        document.getElementById(tab.dataset.tab + "-tab").classList.add("active");
    });
});
</script>
{% endblock %}
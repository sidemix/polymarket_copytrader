<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Trading Bot Dashboard</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
/* [ALL CSS FROM ORIGINAL TEMPLATE REMAINS EXACTLY THE SAME] */
{{ include 'styles.css' }}
</style>
</head>

<body>
<div class="container">

<div class="header">
    <div class="header-top">
        <h1><i class="fas fa-robot fa-icon"></i> Trading Bot Dashboard</h1>

        <div class="header-controls">
            <div class="notification-bell" onclick="toggleNotifications()">
                <i class="fas fa-bell fa-icon"></i>
                <span class="notification-badge" id="notificationCount">0</span>
                <div class="notifications-panel" id="notificationsPanel">
                    <div class="notifications-header">
                        <h3><i class="fas fa-bell fa-icon"></i> Notifications</h3>
                        <div>
                            <button class="btn-clear" onclick="clearAllNotifications()">Clear All</button>
                            <button class="btn-clear" onclick="markAllAsRead()">Mark Read</button>
                        </div>
                    </div>
                    <div class="notifications-body" id="notificationsList">
                        <div class="no-notifications">No notifications</div>
                    </div>
                </div>
            </div>

            <button id="startBtn" class="btn" onclick="controlBot('start')"><i class="fas fa-play"></i> Start</button>
            <button id="stopBtn" class="btn stop" onclick="controlBot('stop')" disabled><i class="fas fa-stop"></i> Stop</button>
            <span id="status">Status: {{ settings.global_trading_status }}</span>
            <span id="mode">Mode: {{ settings.global_trading_mode }}</span>
            {% if settings.dry_run_enabled %}
            <span style="color: #ff9800; font-weight: bold;">DRY RUN</span>
            {% endif %}
        </div>
    </div>
</div>

<!-- TABS -->
<div class="tab-container">
    <button class="tab active" data-tab="overview"><i class="fas fa-chart-bar fa-icon"></i> Overview</button>
    <button class="tab" data-tab="analytics"><i class="fas fa-chart-line fa-icon"></i> Analytics</button>
    <button class="tab" data-tab="wallets"><i class="fas fa-wallet fa-icon"></i> Wallets</button>
    <button class="tab" data-tab="discovery"><i class="fas fa-search fa-icon"></i> Discovery</button>
    <button class="tab" data-tab="risk"><i class="fas fa-shield-alt fa-icon"></i> Risk</button>
    <button class="tab" data-tab="settings"><i class="fas fa-cog fa-icon"></i> Settings</button>
</div>

<!-- OVERVIEW TAB -->
<div id="overview-tab" class="tab-content active">
    <div class="panel">
        <h3><i class="fas fa-chart-bar fa-icon"></i> Performance Stats</h3>
        <div class="stats-grid">
            <div class="stat"><div class="stat-value" id="totalTrades">{{ stats.total_trades }}</div><div>Total Trades</div></div>
            <div class="stat"><div class="stat-value" id="profitableTrades">{{ stats.profitable_trades }}</div><div>Profitable Trades</div></div>
            <div class="stat"><div class="stat-value" id="totalProfit">${{ "%.2f"|format(stats.total_profit) }}</div><div>Total Profit</div></div>
            <div class="stat"><div class="stat-value" id="winRate">{{ "%.1f"|format(stats.win_rate) }}%</div><div>Win Rate</div></div>
            <div class="stat"><div class="stat-value" id="activeWallets">{{ stats.active_wallets }}</div><div>Active Wallets</div></div>
            <div class="stat"><div class="stat-value" id="riskLevel">{{ stats.risk_level }}</div><div>Risk Level</div></div>
        </div>
    </div>

    <div class="charts-grid">
        <div class="panel">
            <h3><i class="fas fa-trophy fa-icon"></i> Top Performing Wallets</h3>
            <div class="wallet-list" id="topWallets">
                {% for wallet in top_wallets %}
                <div class="wallet-item">
                    <div>
                        <div class="wallet-nickname">{{ wallet.nickname }}</div>
                        <div class="wallet-address">{{ wallet.address[:10] }}...{{ wallet.address[-8:] }}</div>
                        <div class="wallet-stats">{{ wallet.trades|length }} trades</div>
                    </div>
                    <div class="wallet-actions">
                        <button class="btn btn-small" onclick="toggleWallet({{ wallet.id }})">
                            {% if wallet.is_active %}Pause{% else %}Resume{% endif %}
                        </button>
                    </div>
                </div>
                {% else %}
                <div style="text-align: center; color: #888; padding: 20px;">
                    No wallets configured
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="panel">
            <h3><i class="fas fa-list fa-icon"></i> Recent Activity</h3>
            <div id="output">
                {% for event in recent_events %}
                [{{ event.created_at.strftime('%H:%M:%S') }}] {{ event.message }}<br>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- ANALYTICS TAB -->
<div id="analytics-tab" class="tab-content">
    <div class="panel">
        <h3><i class="fas fa-chart-line fa-icon"></i> Performance Analytics</h3>
        <div class="charts-grid">
            <div class="chart-container"><canvas id="profitChart"></canvas></div>
            <div class="chart-container"><canvas id="tradesChart"></canvas></div>
        </div>
        <div class="charts-grid">
            <div class="chart-container"><canvas id="walletPerformanceChart"></canvas></div>
            <div class="chart-container"><canvas id="winRateChart"></canvas></div>
        </div>
    </div>
</div>

<!-- WALLETS TAB -->
<div id="wallets-tab" class="tab-content">
    <div class="charts-grid">
        <div class="panel">
            <h3><i class="fas fa-wallet fa-icon"></i> Wallet Management</h3>
            <div style="margin-bottom: 15px;">
                <button class="btn" onclick="showAddWalletModal()"><i class="fas fa-plus"></i> Add Wallet</button>
            </div>
            <div id="walletsList">
                {% for wallet in top_wallets %}
                <div class="wallet-item">
                    <div>
                        <div class="wallet-nickname">{{ wallet.nickname }}</div>
                        <div class="wallet-address">{{ wallet.address }}</div>
                        <div class="wallet-stats">
                            {{ wallet.trades|length }} trades | 
                            Last: {{ wallet.last_monitored.strftime('%Y-%m-%d %H:%M') if wallet.last_monitored else 'Never' }}
                        </div>
                    </div>
                    <div class="wallet-actions">
                        <button class="btn btn-small {% if not wallet.is_active %}warning{% endif %}" 
                                onclick="toggleWallet({{ wallet.id }})">
                            {% if wallet.is_active %}Pause{% else %}Resume{% endif %}
                        </button>
                        <button class="btn btn-small stop" onclick="deleteWallet({{ wallet.id }})">Delete</button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="panel">
            <h3><i class="fas fa-chart-line fa-icon"></i> Wallet Performance</h3>
            <div class="wallet-list" id="walletPerformance">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>
    </div>
</div>

<!-- DISCOVERY TAB -->
<div id="discovery-tab" class="tab-content">
    <div class="panel">
        <h3><i class="fas fa-search fa-icon"></i> Auto Wallet Discovery</h3>
        <div style="margin-bottom: 15px;">
            <button class="btn" onclick="discoverWallets()"><i class="fas fa-search"></i> Find Profitable Wallets</button>
            <button class="btn warning" onclick="stopDiscovery()"><i class="fas fa-stop"></i> Stop Discovery</button>
        </div>
        <div id="discoveryResults">
            <div class="discovery-item">Click "Find Profitable Wallets" to discover new trading opportunities</div>
        </div>
    </div>
</div>

<!-- RISK TAB -->
<div id="risk-tab" class="tab-content">
    <div class="charts-grid">
        <div class="panel">
            <h3><i class="fas fa-shield-alt fa-icon"></i> Risk Controls</h3>

            <div style="margin-bottom: 15px;">
                <label><i class="fas fa-percentage fa-icon"></i> Copy Trading Percentage:</label>
                <input type="range" id="copyPercentage" min="1" max="100" value="{{ settings.copy_trade_percentage }}">
                <span id="copyPercentageValue">{{ settings.copy_trade_percentage }}%</span>
            </div>

            <div style="margin-bottom: 15px;">
                <label><i class="fas fa-dollar-sign fa-icon"></i> Max Trade Amount ($):</label>
                <input type="number" id="maxTradeAmount" value="{{ settings.max_trade_amount }}">
            </div>

            <div style="margin-bottom: 15px;">
                <label><i class="fas fa-exclamation-triangle fa-icon"></i> Daily Loss Limit ($):</label>
                <input type="number" id="dailyLossLimit" value="{{ settings.daily_loss_limit }}">
            </div>

            <div style="margin-bottom: 15px;">
                <label><i class="fas fa-clock fa-icon"></i> Max Trades Per Hour:</label>
                <input type="number" id="maxTradesPerHour" value="{{ settings.max_trades_per_hour }}">
            </div>

            <button class="btn" onclick="updateRiskSettings()"><i class="fas fa-save"></i> Update Risk Settings</button>
        </div>

        <div class="panel">
            <h3><i class="fas fa-balance-scale fa-icon"></i> Balance Management</h3>

            <div style="margin-bottom: 15px;">
                <label>Available Cash:</label>
                <input type="number" id="cashInput" value="5920">
            </div>

            <div style="margin-bottom: 15px;">
                <label>Portfolio Value:</label>
                <input type="number" id="portfolioInput" value="10019">
            </div>

            <div style="margin-bottom: 15px;">
                <label>Risk Tolerance:</label>
                <select id="riskTolerance">
                    <option value="low">Low (Conservative)</option>
                    <option value="medium" selected>Medium (Balanced)</option>
                    <option value="high">High (Aggressive)</option>
                </select>
            </div>

            <button class="btn" onclick="updateBalance()"><i class="fas fa-save"></i> Update Balance</button>

            <div style="margin-top: 20px; padding: 15px; background: #3d3d3d; border-radius: 5px;">
                <h4><i class="fas fa-info-circle fa-icon"></i> Risk Status</h4>
                <div id="riskStatus">All systems normal</div>
                <div class="wallet-stats" id="riskStats">Daily P&L: $0 | Trades Today: 0</div>
            </div>
        </div>
    </div>
</div>

<!-- SETTINGS TAB -->
<div id="settings-tab" class="tab-content">
    <div class="panel">
        <h3><i class="fas fa-cog fa-icon"></i> Bot Configuration</h3>

        <div class="settings-grid">
            <div>
                <label>Minimum Trade Amount ($):</label>
                <input type="number" id="minTradeAmount" value="{{ settings.min_market_volume }}">
            </div>
            <div>
                <label>Cooldown Between Trades (seconds):</label>
                <input type="number" id="tradeCooldown" value="30">
            </div>
            <div>
                <label>Auto-stop on Daily Loss:</label>
                <select id="autoStopEnabled">
                    <option value="true">Enabled</option>
                    <option value="false">Disabled</option>
                </select>
            </div>
            <div>
                <label>Push Notifications:</label>
                <select id="pushNotifications">
                    <option value="true">Enabled</option>
                    <option value="false">Disabled</option>
                </select>
            </div>
        </div>

        <div class="settings-grid" style="margin-top: 20px;">
            <div>
                <label>Trading Mode:</label>
                <select id="tradingMode">
                    <option value="TEST" {% if settings.global_trading_mode == "TEST" %}selected{% endif %}>TEST</option>
                    <option value="LIVE" {% if settings.global_trading_mode == "LIVE" %}selected{% endif %}>LIVE</option>
                </select>
            </div>
            <div>
                <label>Dry Run Mode:</label>
                <select id="dryRunEnabled">
                    <option value="true" {% if settings.dry_run_enabled %}selected{% endif %}>Enabled</option>
                    <option value="false" {% if not settings.dry_run_enabled %}selected{% endif %}>Disabled</option>
                </select>
            </div>
        </div>

        <button class="btn" onclick="updateBotSettings()" style="margin-top: 15px;">
            <i class="fas fa-save"></i> Update Bot Settings
        </button>
    </div>
</div>

</div> <!-- end container -->

<!-- ADD WALLET MODAL -->
<div id="addWalletModal" class="modal">
    <div class="modal-content">
        <h3><i class="fas fa-plus fa-icon"></i> Add Wallet</h3>

        <div class="wallet-input-row">
            <input type="text" id="walletNickname" placeholder="Nickname">
        </div>

        <div class="wallet-input-row">
            <input type="text" id="walletAddress" placeholder="Wallet Address">
        </div>

        <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button class="btn" onclick="addWallet()"><i class="fas fa-save"></i> Add Wallet</button>
            <button class="btn stop" onclick="hideAddWalletModal()">Cancel</button>
        </div>
    </div>
</div>

<script>
// CSRF Token for form submissions
const csrfToken = "{{ request.session.get('csrf_token', '') }}";

// Initialize dashboard with current state
document.addEventListener('DOMContentLoaded', function() {
    updateBotStatus("{{ settings.global_trading_status }}");
    setupTabs();
    initializeCharts();
    loadRealTimeData();
});

// Bot control functions
async function controlBot(action) {
    try {
        const response = await fetch(`/api/bot/${action}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        if (response.ok) {
            const result = await response.json();
            alert(result.message);
            location.reload();
        } else {
            const error = await response.json();
            alert('Error: ' + error.detail);
        }
    } catch (error) {
        alert('Error controlling bot: ' + error.message);
    }
}

// Wallet management
async function addWallet() {
    const nickname = document.getElementById('walletNickname').value;
    const address = document.getElementById('walletAddress').value;
    
    if (!nickname || !address) {
        alert('Please fill in all fields');
        return;
    }
    
    const formData = new FormData();
    formData.append('nickname', nickname);
    formData.append('address', address);
    
    try {
        const response = await fetch('/api/wallets', {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            alert('Wallet added successfully');
            hideAddWalletModal();
            location.reload();
        } else {
            const error = await response.json();
            alert('Error: ' + error.detail);
        }
    } catch (error) {
        alert('Error adding wallet: ' + error.message);
    }
}

async function deleteWallet(walletId) {
    if (!confirm('Are you sure you want to delete this wallet?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/wallets/${walletId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            alert('Wallet deleted successfully');
            location.reload();
        } else {
            const error = await response.json();
            alert('Error: ' + error.detail);
        }
    } catch (error) {
        alert('Error deleting wallet: ' + error.message);
    }
}

// Settings management
async function updateRiskSettings() {
    const settings = {
        copy_trade_percentage: parseFloat(document.getElementById('copyPercentage').value),
        max_trade_amount: parseFloat(document.getElementById('maxTradeAmount').value),
        daily_loss_limit: parseFloat(document.getElementById('dailyLossLimit').value),
        max_trades_per_hour: parseInt(document.getElementById('maxTradesPerHour').value)
    };
    
    try {
        const response = await fetch('/api/settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(settings)
        });
        
        if (response.ok) {
            alert('Risk settings updated successfully');
        } else {
            const error = await response.json();
            alert('Error: ' + error.detail);
        }
    } catch (error) {
        alert('Error updating settings: ' + error.message);
    }
}

// Real-time data updates
async function loadRealTimeData() {
    try {
        const [statsResponse, walletsResponse] = await Promise.all([
            fetch('/api/stats'),
            fetch('/api/wallets')
        ]);
        
        if (statsResponse.ok) {
            const stats = await statsResponse.json();
            updateStatsDisplay(stats);
        }
        
        // Update every 30 seconds
        setTimeout(loadRealTimeData, 30000);
    } catch (error) {
        console.error('Error loading real-time data:', error);
        setTimeout(loadRealTimeData, 30000);
    }
}

function updateStatsDisplay(stats) {
    document.getElementById('totalTrades').textContent = stats.totalTrades;
    document.getElementById('profitableTrades').textContent = stats.profitableTrades;
    document.getElementById('totalProfit').textContent = '$' + stats.totalProfit;
    document.getElementById('winRate').textContent = stats.winRate + '%';
    document.getElementById('activeWallets').textContent = stats.activeWallets;
    document.getElementById('riskLevel').textContent = stats.riskLevel;
}

function updateBotStatus(status) {
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const statusSpan = document.getElementById('status');
    
    statusSpan.textContent = 'Status: ' + status;
    
    if (status === 'RUNNING') {
        startBtn.disabled = true;
        stopBtn.disabled = false;
    } else {
        startBtn.disabled = false;
        stopBtn.disabled = true;
    }
}

// Tab functionality
function setupTabs() {
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');
    
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            const tabName = tab.getAttribute('data-tab');
            
            // Update active tab
            tabs.forEach(t => t.classList.remove('active'));
            tabContents.forEach(tc => tc.classList.remove('active'));
            
            tab.classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
        });
    });
}

// Modal functions
function showAddWalletModal() {
    document.getElementById('addWalletModal').style.display = 'flex';
}

function hideAddWalletModal() {
    document.getElementById('addWalletModal').style.display = 'none';
}

// Initialize charts (placeholder)
function initializeCharts() {
    // Chart initialization would go here
    console.log('Charts initialized');
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('addWalletModal');
    if (event.target === modal) {
        hideAddWalletModal();
    }
}

// Update percentage display
document.getElementById('copyPercentage').addEventListener('input', function() {
    document.getElementById('copyPercentageValue').textContent = this.value + '%';
});
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <!-- ============================================================================= -->
    <!-- HEAD SECTION - META, STYLES, AND IMPORTS -->
    <!-- ============================================================================= -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Bot Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        /* ============================================================================= */
        /* CSS STYLES - DASHBOARD STYLING */
        /* ============================================================================= */
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: white;
            padding: 10px;
        }

        .container { max-width: 1400px; margin: 0 auto; }
        .header { background: #2d2d2d; padding: 15px; border-radius: 10px; margin-bottom: 15px; display: flex; flex-direction: column; gap: 15px; }
        .header-top { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .header-controls { display: flex; align-items: center; flex-wrap: wrap; gap: 10px; }

        .panel { background: #2d2d2d; padding: 15px; border-radius: 10px; margin-bottom: 15px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 15px; }

        .stat { background: #3d3d3d; padding: 12px; border-radius: 8px; text-align: center; }
        .stat-value { font-size: 20px; font-weight: bold; color: #4CAF50; }
        .stat.negative .stat-value { color: #f44336; }

        .btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            margin: 3px;
            font-size: 14px;
        }
        .btn.stop { background: #f44336; }
        .btn.warning { background: #ff9800; }
        .btn.small { padding: 4px 8px; font-size: 12px; }
        .btn:disabled { background: #666; cursor: not-allowed; }

        .wallet-list { max-height: 300px; overflow-y: auto; }
        .wallet-item {
            background: #3d3d3d; padding: 12px; margin: 4px 0;
            border-radius: 5px; display: flex; justify-content: space-between;
            align-items: center; flex-wrap: wrap; gap: 8px;
        }
        .wallet-actions { display: flex; gap: 8px; flex-wrap: wrap; }
        .wallet-profit { color: #4CAF50; }
        .wallet-loss { color: #f44336; }
        .wallet-paused { opacity: 0.6; }

        textarea, input, select {
            width: 100%; padding: 8px; margin: 4px 0; background: #3d3d3d;
            border: 1px solid #555; color: white; border-radius: 5px; font-size: 14px;
        }

        #output {
            background: #1a1a1a; padding: 8px; border-radius: 5px;
            height: 150px; overflow-y: auto; font-family: monospace;
            font-size: 11px; white-space: pre-wrap;
        }

        .settings-grid { display: grid; grid-template-columns: 1fr; gap: 12px; margin-top: 12px; }

        .wallet-stats { font-size: 11px; color: #ccc; margin-top: 4px; }

        .tab-container {
            display: flex; margin-bottom: 15px; background: #2d2d2d;
            border-radius: 10px; padding: 4px; flex-wrap: wrap;
        }
        .tab {
            padding: 10px 15px; cursor: pointer; border-radius: 5px;
            flex: 1; text-align: center; transition: background 0.3s;
            border: none; background: transparent; color: white; font-size: 13px;
            min-width: 120px;
        }
        .tab:hover { background: #3d3d3d; }
        .tab.active { background: #4CAF50; }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .notification-bell {
            position: relative; cursor: pointer;
            padding: 8px; background: #3d3d3d;
            border-radius: 50%; width: 40px; height: 40px;
            display: flex; align-items: center; justify-content: center;
        }

        .notification-badge {
            position: absolute; top: -5px; right: -5px;
            background: #f44336; color: white; border-radius: 50%;
            width: 20px; height: 20px; font-size: 11px;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold;
        }

        @media (min-width: 768px) {
            body { padding: 20px; }
            .header { padding: 20px; flex-direction: row; }
            .header-top { flex-direction: row; }
            .panel { padding: 20px; }
            .stats-grid { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
            .wallet-item { padding: 15px; flex-wrap: nowrap; }
            .settings-grid { grid-template-columns: 1fr 1fr; }
        }

        .status-running { color: #4CAF50; }
        .status-stopped { color: #f44336; }
        .status-paused { color: #ff9800; }

        .mode-test { color: #ff9800; }
        .mode-live { color: #4CAF50; }
    </style>
</head>
<body>
    <!-- ============================================================================= -->
    <!-- HEADER SECTION - BOT CONTROLS AND STATUS -->
    <!-- ============================================================================= -->
    <div class="container">
        <div class="header">
            <div class="header-top">
                <h1><i class="fas fa-robot fa-icon"></i> Trading Bot Dashboard</h1>

                <div class="header-controls">
                    <button id="startBtn" class="btn" onclick="controlBot('start')"><i class="fas fa-play"></i> Start</button>
                    <button id="stopBtn" class="btn stop" onclick="controlBot('stop')"><i class="fas fa-stop"></i> Stop</button>
                    <button id="pauseBtn" class="btn warning" onclick="controlBot('pause')"><i class="fas fa-pause"></i> Pause</button>
                    
                    <span id="status">Status: <span class="status-stopped" id="statusText">STOPPED</span></span>
                    <span id="mode">Mode: <span class="mode-test" id="modeText">TEST</span></span>
                    <span id="dryRun" style="color: #ff9800; font-weight: bold;">DRY RUN</span>
                </div>
            </div>
        </div>

        <!-- ============================================================================= -->
        <!-- TAB NAVIGATION -->
        <!-- ============================================================================= -->
        <div class="tab-container">
            <button class="tab active" data-tab="overview"><i class="fas fa-chart-bar fa-icon"></i> Overview</button>
            <button class="tab" data-tab="analytics"><i class="fas fa-chart-line fa-icon"></i> Analytics</button>
            <button class="tab" data-tab="wallets"><i class="fas fa-wallet fa-icon"></i> Wallets</button>
            <button class="tab" data-tab="discovery"><i class="fas fa-search fa-icon"></i> Discovery</button>
            <button class="tab" data-tab="risk"><i class="fas fa-shield-alt fa-icon"></i> Risk</button>
            <button class="tab" data-tab="settings"><i class="fas fa-cog fa-icon"></i> Settings</button>
        </div>

        <!-- ============================================================================= -->
        <!-- OVERVIEW TAB CONTENT -->
        <!-- ============================================================================= -->
        <div id="overview-tab" class="tab-content active">
            <div class="panel">
                <h3><i class="fas fa-chart-bar fa-icon"></i> Performance Stats</h3>
                <div class="stats-grid">
                    <div class="stat"><div class="stat-value" id="totalTrades">0</div><div>Total Trades</div></div>
                    <div class="stat"><div class="stat-value" id="profitableTrades">0</div><div>Profitable Trades</div></div>
                    <div class="stat"><div class="stat-value" id="totalProfit">$0.00</div><div>Total Profit</div></div>
                    <div class="stat"><div class="stat-value" id="winRate">0%</div><div>Win Rate</div></div>
                    <div class="stat"><div class="stat-value" id="activeWallets">0</div><div>Active Wallets</div></div>
                    <div class="stat"><div class="stat-value" id="riskLevel">Low</div><div>Risk Level</div></div>
                </div>
            </div>

            <div class="panel">
                <h3><i class="fas fa-list fa-icon"></i> Recent Activity</h3>
                <div id="output">System started. Waiting for activity...</div>
            </div>
        </div>

        <!-- ============================================================================= -->
        <!-- ANALYTICS TAB CONTENT -->
        <!-- ============================================================================= -->
        <div id="analytics-tab" class="tab-content">
            <div class="panel">
                <h3><i class="fas fa-chart-line fa-icon"></i> Performance Analytics</h3>
                <p>Analytics charts will be displayed here once trading data is available.</p>
            </div>
        </div>

        <!-- ============================================================================= -->
        <!-- WALLETS TAB CONTENT -->
        <!-- ============================================================================= -->
        <div id="wallets-tab" class="tab-content">
            <div class="panel">
                <h3><i class="fas fa-wallet fa-icon"></i> Wallet Management</h3>
                <div style="margin-bottom: 15px;">
                    <button class="btn" onclick="showAddWalletModal()"><i class="fas fa-plus"></i> Add Wallet</button>
                    <button class="btn warning" onclick="refreshWallets()"><i class="fas fa-sync"></i> Refresh</button>
                </div>
                <div class="wallet-list" id="walletsList">
                    <div class="no-wallets">No wallets configured. Click "Add Wallet" to get started.</div>
                </div>
            </div>
        </div>

        <!-- ============================================================================= -->
        <!-- DISCOVERY TAB CONTENT -->
        <!-- ============================================================================= -->
        <div id="discovery-tab" class="tab-content">
            <div class="panel">
                <h3><i class="fas fa-search fa-icon"></i> Auto Wallet Discovery</h3>
                <p>Wallet discovery features will be available here.</p>
            </div>
        </div>

        <!-- ============================================================================= -->
        <!-- RISK TAB CONTENT -->
        <!-- ============================================================================= -->
        <div id="risk-tab" class="tab-content">
            <div class="panel">
                <h3><i class="fas fa-shield-alt fa-icon"></i> Risk Management</h3>
                <div class="settings-grid">
                    <div>
                        <label><i class="fas fa-percentage fa-icon"></i> Copy Trading Percentage:</label>
                        <input type="range" id="copyPercentage" min="1" max="100" value="20" oninput="updatePercentageValue()">
                        <span id="copyPercentageValue">20%</span>
                    </div>
                    <div>
                        <label><i class="fas fa-dollar-sign fa-icon"></i> Max Trade Amount ($):</label>
                        <input type="number" id="maxTradeAmount" value="100">
                    </div>
                </div>
                <button class="btn" onclick="updateRiskSettings()" style="margin-top: 15px;">
                    <i class="fas fa-save"></i> Update Risk Settings
                </button>
            </div>
        </div>

        <!-- ============================================================================= -->
        <!-- SETTINGS TAB CONTENT - MODE MANAGEMENT -->
        <!-- ============================================================================= -->
        <div id="settings-tab" class="tab-content">
            <!-- Trading Mode Management Panel -->
            <div class="panel">
                <h3><i class="fas fa-exchange-alt fa-icon"></i> Trading Mode Management</h3>
                <div id="modeInfo" style="margin-bottom: 20px;">
                    <div style="text-align: center; padding: 20px; color: #888;">
                        <i class="fas fa-spinner fa-spin"></i> Loading mode information...
                    </div>
                </div>

                <div class="settings-grid">
                    <div>
                        <label>Trading Mode:</label>
                        <select id="tradingMode" onchange="showModeSwitchWarning()">
                            <option value="TEST">TEST</option>
                            <option value="LIVE">LIVE</option>
                        </select>
                    </div>
                    <div>
                        <label>Dry Run Mode:</label>
                        <select id="dryRunEnabled">
                            <option value="true">Enabled</option>
                            <option value="false">Disabled</option>
                        </select>
                        <div class="wallet-stats" id="dryRunHelp">
                            Dry run simulates trades without real money
                        </div>
                    </div>
                </div>

                <!-- ============================================================================= -->
                <!-- QUICK ACTIONS SECTION - MODE SWITCHING AND STATS CLEARING -->
                <!-- ============================================================================= -->
                <div style="margin-top: 15px; padding: 15px; background: #3d3d3d; border-radius: 8px;">
                    <h4><i class="fas fa-broom"></i> Quick Actions</h4>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn warning" onclick="resetAnalytics()">
                            <i class="fas fa-trash"></i> Clear All Stats
                        </button>
                        <button class="btn" id="quickSwitchBtn" onclick="quickSwitchMode()">
                            <i class="fas fa-exchange-alt"></i> Switch Mode
                        </button>
                    </div>
                    <div class="wallet-stats" style="margin-top: 10px;">
                        Clear stats when switching from test to live mode to keep analytics separate.
                    </div>
                </div>

                <div style="margin-top: 15px; padding: 15px; background: #3d3d3d; border-radius: 8px;">
                    <h4><i class="fas fa-info-circle"></i> Mode Information</h4>
                    <div class="wallet-stats">
                        <div><strong>TEST Mode:</strong> Perfect for strategy development</div>
                        <div>- Dry run enabled by default</div>
                        <div>- No real money involved</div>
                        <div>- Analytics reset when switching to LIVE</div>
                    </div>
                    <div class="wallet-stats" style="margin-top: 10px;">
                        <div><strong>LIVE Mode:</strong> Real trading with actual funds</div>
                        <div>- Requires private key configuration</div>
                        <div>- Real blockchain transactions</div>
                        <div>- Separate analytics from TEST mode</div>
                    </div>
                </div>
            </div>

            <!-- Risk Management Panel -->
            <div class="panel">
                <h3><i class="fas fa-shield-alt fa-icon"></i> Risk Management</h3>

                <div class="settings-grid">
                    <div>
                        <label><i class="fas fa-percentage fa-icon"></i> Copy Trading Percentage:</label>
                        <input type="range" id="copyPercentage" min="1" max="100" value="20" oninput="updatePercentageValue()">
                        <span id="copyPercentageValue">20%</span>
                    </div>
                    <div>
                        <label><i class="fas fa-dollar-sign fa-icon"></i> Max Trade Amount ($):</label>
                        <input type="number" id="maxTradeAmount" value="100">
                        <div class="wallet-stats">Maximum per trade in USD</div>
                    </div>
                    <div>
                        <label><i class="fas fa-chart-line fa-icon"></i> Min Market Volume ($):</label>
                        <input type="number" id="minMarketVolume" value="1000">
                        <div class="wallet-stats">Skip low-volume markets</div>
                    </div>
                    <div>
                        <label><i class="fas fa-clock fa-icon"></i> Max Days to Resolution:</label>
                        <input type="number" id="maxDaysResolution" value="30">
                        <div class="wallet-stats">Avoid long-term markets</div>
                    </div>
                </div>

                <div class="settings-grid" style="margin-top: 15px;">
                    <div>
                        <label><i class="fas fa-exclamation-triangle fa-icon"></i> Daily Loss Limit ($):</label>
                        <input type="number" id="dailyLossLimit" value="200">
                        <div class="wallet-stats">Auto-stop on daily loss</div>
                    </div>
                    <div>
                        <label><i class="fas fa-stopwatch fa-icon"></i> Trade Cooldown (seconds):</label>
                        <input type="number" id="tradeCooldown" value="30">
                        <div class="wallet-stats">Wait between trades</div>
                    </div>
                    <div>
                        <label><i class="fas fa-hourglass fa-icon"></i> Wallet Poll Interval (seconds):</label>
                        <input type="number" id="pollInterval" value="30">
                        <div class="wallet-stats">How often to check wallets</div>
                    </div>
                </div>

                <button class="btn" onclick="updateBotSettings()" style="margin-top: 15px;">
                    <i class="fas fa-save"></i> Save All Settings
                </button>
            </div>

            <!-- Analytics Management Panel -->
            <div class="panel">
                <h3><i class="fas fa-chart-bar fa-icon"></i> Analytics & Data Management</h3>
                
                <div style="margin-bottom: 20px; padding: 15px; background: #3d3d3d; border-radius: 8px;">
                    <h4><i class="fas fa-database"></i> Current Analytics</h4>
                    <div class="wallet-stats" id="analyticsStats">
                        Loading analytics data...
                    </div>
                </div>

                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn warning" onclick="resetAnalytics()" id="resetAnalyticsBtn">
                        <i class="fas fa-trash"></i> Clear All Stats
                    </button>
                    <button class="btn" onclick="exportAnalytics()" id="exportAnalyticsBtn">
                        <i class="fas fa-download"></i> Export Analytics
                    </button>
                    <button class="btn" onclick="clearSystemEvents()" id="clearEventsBtn">
                        <i class="fas fa-broom"></i> Clear System Events
                    </button>
                </div>

                <div style="margin-top: 15px; padding: 12px; background: #2d2d2d; border-radius: 5px; border-left: 4px solid #ff9800;">
                    <i class="fas fa-exclamation-triangle" style="color: #ff9800;"></i>
                    <strong>Warning:</strong> Clearing stats will permanently delete all trade history and statistics. This action cannot be undone.
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================================================= -->
    <!-- ADD WALLET MODAL -->
    <!-- ============================================================================= -->
    <div id="addWalletModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center;">
        <div class="modal-content" style="background: #2d2d2d; padding: 20px; border-radius: 10px; width: 100%; max-width: 400px;">
            <h3><i class="fas fa-plus fa-icon"></i> Add Wallet</h3>

            <div style="margin-bottom: 15px;">
                <input type="text" id="walletNickname" placeholder="Wallet Nickname" style="margin-bottom: 10px;">
                <input type="text" id="walletAddress" placeholder="Wallet Address (0x...)">
            </div>

            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button class="btn" onclick="addWallet()"><i class="fas fa-save"></i> Add Wallet</button>
                <button class="btn stop" onclick="hideAddWalletModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- ============================================================================= -->
    <!-- JAVASCRIPT SECTION - DASHBOARD FUNCTIONALITY -->
    <!-- ============================================================================= -->
    <script>
        // =============================================================================
        // GLOBAL STATE AND INITIALIZATION
        // =============================================================================
        let socket = null;
        let currentSettings = {};
        let currentBotStatus = 'STOPPED';

        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeSocket();
            setupTabs();
            loadInitialData();
            startDataRefresh();
        });

        // =============================================================================
        // SOCKET.IO COMMUNICATION
        // =============================================================================
        function initializeSocket() {
            socket = io();
            
            socket.on('connect', function() {
                console.log('Socket connected');
            });
            
            socket.on('disconnect', function() {
                console.log('Socket disconnected');
            });
            
            socket.on('status_update', function(data) {
                updateBotStatus(data.status);
            });
            
            socket.on('trade_update', function(data) {
                addOutput(`[TRADE] ${data.side} ${data.amount} @ $${data.price} - ${data.market_id}`);
                refreshStats();
            });

            socket.on('mode_update', function(data) {
                loadSettings(); // Refresh settings when mode changes
            });
        }

        // =============================================================================
        // TAB MANAGEMENT
        // =============================================================================
        function setupTabs() {
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.getAttribute('data-tab');
                    
                    // Update active tab
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(tc => tc.classList.remove('active'));
                    
                    tab.classList.add('active');
                    document.getElementById(`${tabName}-tab`).classList.add('active');
                    
                    // Refresh tab-specific data
                    if (tabName === 'wallets') refreshWallets();
                });
            });
        }

        // =============================================================================
        // DATA LOADING FUNCTIONS
        // =============================================================================
        async function loadInitialData() {
            await Promise.all([
                loadSettings(),
                refreshStats(),
                refreshWallets(),
                loadEvents()
            ]);
        }

        async function loadSettings() {
            try {
                const response = await fetch('/api/settings');
                if (response.ok) {
                    currentSettings = await response.json();
                    updateSettingsDisplay();
                    updateModeDisplay(currentSettings);
                    updateAnalyticsStats();
                    updateHeaderDisplay();
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        async function refreshStats() {
            try {
                const response = await fetch('/api/stats');
                if (response.ok) {
                    const stats = await response.json();
                    updateStatsDisplay(stats);
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function refreshWallets() {
            try {
                const response = await fetch('/api/wallets');
                if (response.ok) {
                    const wallets = await response.json();
                    updateWalletsDisplay(wallets);
                }
            } catch (error) {
                console.error('Error loading wallets:', error);
            }
        }

        async function loadEvents() {
            try {
                const response = await fetch('/api/events');
                if (response.ok) {
                    const events = await response.json();
                    updateEventsDisplay(events);
                }
            } catch (error) {
                console.error('Error loading events:', error);
            }
        }

        // =============================================================================
        // DISPLAY UPDATE FUNCTIONS
        // =============================================================================
        function updateStatsDisplay(stats) {
            document.getElementById('totalTrades').textContent = stats.totalTrades;
            document.getElementById('profitableTrades').textContent = stats.profitableTrades;
            document.getElementById('totalProfit').textContent = '$' + stats.totalProfit.toFixed(2);
            document.getElementById('winRate').textContent = stats.winRate + '%';
            document.getElementById('activeWallets').textContent = stats.activeWallets;
            document.getElementById('riskLevel').textContent = stats.riskLevel;
        }

        function updateWalletsDisplay(wallets) {
            const walletsList = document.getElementById('walletsList');
            
            if (wallets.length === 0) {
                walletsList.innerHTML = '<div class="no-wallets">No wallets configured. Click "Add Wallet" to get started.</div>';
                return;
            }
            
            walletsList.innerHTML = wallets.map(wallet => `
                <div class="wallet-item ${!wallet.is_active ? 'wallet-paused' : ''}">
                    <div>
                        <div class="wallet-nickname">${wallet.nickname || 'Unnamed Wallet'}</div>
                        <div class="wallet-address">${wallet.address}</div>
                        <div class="wallet-stats">
                            ${wallet.trade_count || 0} trades | 
                            Last: ${wallet.last_monitored ? new Date(wallet.last_monitored).toLocaleDateString() : 'Never'}
                        </div>
                    </div>
                    <div class="wallet-actions">
                        <button class="btn btn-small stop" onclick="deleteWallet(${wallet.id})">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function updateSettingsDisplay() {
            if (!currentSettings) return;
            
            document.getElementById('copyPercentage').value = currentSettings.copy_trade_percentage || 20;
            document.getElementById('maxTradeAmount').value = currentSettings.max_trade_amount || 100;
            document.getElementById('dailyLossLimit').value = currentSettings.daily_loss_limit || 200;
            document.getElementById('minMarketVolume').value = currentSettings.min_market_volume || 1000;
            document.getElementById('pollInterval').value = currentSettings.poll_interval || 30;
            document.getElementById('maxDaysResolution').value = currentSettings.max_days_to_resolution || 30;
            document.getElementById('tradingMode').value = currentSettings.global_trading_mode || 'TEST';
            document.getElementById('dryRunEnabled').value = currentSettings.dry_run_enabled ? 'true' : 'false';
            document.getElementById('tradeCooldown').value = currentSettings.trade_cooldown || 30;
            
            updateBotStatus(currentSettings.global_trading_status || 'STOPPED');
            updatePercentageValue();
            
            // Update quick switch button
            const quickSwitchBtn = document.getElementById('quickSwitchBtn');
            if (quickSwitchBtn && currentSettings.global_trading_mode) {
                const newMode = currentSettings.global_trading_mode === 'TEST' ? 'LIVE' : 'TEST';
                quickSwitchBtn.innerHTML = `<i class="fas fa-exchange-alt"></i> Switch to ${newMode}`;
            }
        }

        function updateEventsDisplay(events) {
            const output = document.getElementById('output');
            output.innerHTML = events.map(event => 
                `[${new Date(event.created_at).toLocaleTimeString()}] ${event.message}`
            ).join('\n');
            output.scrollTop = output.scrollHeight;
        }

        // =============================================================================
        // BOT CONTROL FUNCTIONS
        // =============================================================================
        async function controlBot(action) {
            try {
                const response = await fetch(`/api/bot/${action}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(result.message);
                    await loadSettings();
                } else {
                    const error = await response.json();
                    alert('Error: ' + error.detail);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        function updateBotStatus(status) {
            currentBotStatus = status;
            const statusElement = document.getElementById('statusText');
            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');
            const pauseBtn = document.getElementById('pauseBtn');
            
            statusElement.textContent = status;
            statusElement.className = `status-${status.toLowerCase()}`;
            
            // Update button states
            startBtn.disabled = status === 'RUNNING';
            stopBtn.disabled = status === 'STOPPED';
            pauseBtn.disabled = status === 'PAUSED';
        }

        // =============================================================================
        // WALLET MANAGEMENT FUNCTIONS
        // =============================================================================
        function showAddWalletModal() {
            document.getElementById('addWalletModal').style.display = 'flex';
        }

        function hideAddWalletModal() {
            document.getElementById('addWalletModal').style.display = 'none';
        }

        async function addWallet() {
            const nickname = document.getElementById('walletNickname').value;
            const address = document.getElementById('walletAddress').value;
            
            if (!nickname || !address) {
                alert('Please fill in all fields');
                return;
            }
            
            if (!address.startsWith('0x') || address.length !== 42) {
                alert('Invalid wallet address format');
                return;
            }
            
            const formData = new FormData();
            formData.append('nickname', nickname);
            formData.append('address', address);
            
            try {
                const response = await fetch('/api/wallets', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    alert('Wallet added successfully');
                    hideAddWalletModal();
                    await refreshWallets();
                    // Clear form
                    document.getElementById('walletNickname').value = '';
                    document.getElementById('walletAddress').value = '';
                } else {
                    const error = await response.json();
                    alert('Error: ' + error.detail);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function deleteWallet(walletId) {
            if (!confirm('Are you sure you want to delete this wallet?')) return;
            
            try {
                const response = await fetch(`/api/wallets/${walletId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    alert('Wallet deleted successfully');
                    await refreshWallets();
                } else {
                    const error = await response.json();
                    alert('Error: ' + error.detail);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // =============================================================================
        // SETTINGS MANAGEMENT FUNCTIONS
        // =============================================================================
        function updatePercentageValue() {
            const slider = document.getElementById('copyPercentage');
            const value = document.getElementById('copyPercentageValue');
            value.textContent = slider.value + '%';
        }

        async function updateRiskSettings() {
            const settings = {
                copy_trade_percentage: parseFloat(document.getElementById('copyPercentage').value),
                max_trade_amount: parseFloat(document.getElementById('maxTradeAmount').value),
                daily_loss_limit: parseFloat(document.getElementById('dailyLossLimit').value)
            };
            
            await updateSettings(settings);
        }

        async function updateBotSettings() {
            const settings = {
                min_market_volume: parseFloat(document.getElementById('minMarketVolume').value),
                max_days_to_resolution: parseInt(document.getElementById('maxDaysResolution').value),
                global_trading_mode: document.getElementById('tradingMode').value,
                dry_run_enabled: document.getElementById('dryRunEnabled').value === 'true',
                copy_trade_percentage: parseFloat(document.getElementById('copyPercentage').value),
                max_trade_amount: parseFloat(document.getElementById('maxTradeAmount').value),
                daily_loss_limit: parseFloat(document.getElementById('dailyLossLimit').value),
                trade_cooldown: parseInt(document.getElementById('tradeCooldown').value),
                poll_interval: parseInt(document.getElementById('pollInterval').value)
            };
            
            try {
                const response = await fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });
                
                if (response.ok) {
                    alert('Settings updated successfully');
                    await loadSettings();
                } else {
                    const error = await response.json();
                    alert('Error: ' + error.detail);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function updateSettings(settings) {
            try {
                const response = await fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });
                
                if (response.ok) {
                    alert('Settings updated successfully');
                    await loadSettings();
                } else {
                    const error = await response.json();
                    alert('Error: ' + error.detail);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // =============================================================================
        // MODE MANAGEMENT FUNCTIONS
        // =============================================================================
        async function switchTradingMode(newMode) {
            const resetAnalytics = confirm(`Switch to ${newMode} mode? This will ${newMode === 'LIVE' ? 'reset analytics and ' : ''}stop the bot.`);
            
            if (!resetAnalytics && newMode === 'LIVE') {
                if (!confirm('WARNING: Switching to LIVE without resetting analytics will mix test and live results. Continue anyway?')) {
                    return;
                }
            }
            
            try {
                const response = await fetch('/api/settings/switch-mode', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        mode: newMode,
                        reset_analytics: resetAnalytics
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(result.message);
                    await loadSettings();
                } else {
                    const error = await response.json();
                    alert('Error: ' + error.detail);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        function quickSwitchMode() {
            if (!currentSettings) return;
            const newMode = currentSettings.global_trading_mode === 'TEST' ? 'LIVE' : 'TEST';
            switchTradingMode(newMode);
        }

        function showModeSwitchWarning() {
            const tradingMode = document.getElementById('tradingMode').value;
            if (tradingMode === 'LIVE') {
                if (!confirm('WARNING: Switching to LIVE mode will execute real trades with actual funds. Make sure your private key is configured and you understand the risks. Continue?')) {
                    document.getElementById('tradingMode').value = 'TEST';
                    return;
                }
            }
        }

        function updateHeaderDisplay() {
            const modeText = document.getElementById('modeText');
            const dryRunElement = document.getElementById('dryRun');
            
            if (currentSettings) {
                // Update mode text
                modeText.textContent = currentSettings.global_trading_mode;
                modeText.className = `mode-${currentSettings.global_trading_mode.toLowerCase()}`;
                
                // Update dry run display
                if (currentSettings.dry_run_enabled) {
                    dryRunElement.style.display = 'inline';
                    dryRunElement.textContent = 'DRY RUN';
                } else {
                    dryRunElement.style.display = 'none';
                }
            }
        }

        function updateModeDisplay(settings) {
            const modeInfo = document.getElementById('modeInfo');
            const modeText = settings.global_trading_mode === 'LIVE' ? 
                `<span class="mode-live">LIVE</span>` : 
                `<span class="mode-test">TEST</span>`;
            
            const modeStatus = settings.global_trading_mode === 'LIVE' ?
                '<span style="color: #4CAF50;">‚óè</span> Real Trading Active' :
                '<span style="color: #ff9800;">‚óè</span> Test Mode Active';
            
            modeInfo.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div>
                        <h4 style="margin: 0; color: #fff;">Current Mode: ${modeText}</h4>
                        <div class="wallet-stats">${modeStatus}</div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn ${settings.global_trading_mode === 'TEST' ? '' : 'stop'}" 
                                onclick="switchTradingMode('${settings.global_trading_mode === 'TEST' ? 'LIVE' : 'TEST'}')"
                                style="min-width: 140px;">
                            <i class="fas fa-exchange-alt"></i> 
                            Switch to ${settings.global_trading_mode === 'TEST' ? 'LIVE' : 'TEST'}
                        </button>
                        <button class="btn warning" onclick="resetAnalytics()">
                            <i class="fas fa-trash"></i> Clear Stats
                        </button>
                    </div>
                </div>
                
                ${settings.test_mode_started ? 
                    `<div class="wallet-stats"><i class="fas fa-play"></i> Test mode started: ${new Date(settings.test_mode_started).toLocaleString()}</div>` : ''}
                ${settings.live_mode_started ? 
                    `<div class="wallet-stats"><i class="fas fa-rocket"></i> Live mode started: ${new Date(settings.live_mode_started).toLocaleString()}</div>` : ''}
                ${settings.last_mode_switch ? 
                    `<div class="wallet-stats"><i class="fas fa-sync"></i> Last mode switch: ${new Date(settings.last_mode_switch).toLocaleString()}</div>` : ''}
                
                <div style="margin-top: 10px; padding: 10px; background: #2d2d2d; border-radius: 5px;">
                    <div class="wallet-stats">
                        <strong>Dry Run:</strong> ${settings.dry_run_enabled ? 
                            '<span style="color: #ff9800;">ENABLED (Simulated trades)</span>' : 
                            '<span style="color: #f44336;">DISABLED (Real trades)</span>'}
                    </div>
                </div>
            `;
            
            // Update dry run help text based on mode
            const dryRunHelp = document.getElementById('dryRunHelp');
            if (settings.global_trading_mode === 'LIVE' && !settings.dry_run_enabled) {
                dryRunHelp.innerHTML = '<span style="color: #f44336;">‚ö†Ô∏è REAL TRADING - Actual funds at risk</span>';
            } else if (settings.global_trading_mode === 'LIVE' && settings.dry_run_enabled) {
                dryRunHelp.innerHTML = '<span style="color: #ff9800;">‚ö†Ô∏è LIVE MODE with Dry Run - No real trades</span>';
            } else {
                dryRunHelp.innerHTML = 'Dry run simulates trades without real money';
            }
        }

        // =============================================================================
        // ANALYTICS MANAGEMENT FUNCTIONS
        // =============================================================================
        async function updateAnalyticsStats() {
            try {
                const [statsResponse, tradesResponse, eventsResponse] = await Promise.all([
                    fetch('/api/stats'),
                    fetch('/api/trades?limit=1'),
                    fetch('/api/events?limit=1')
                ]);
                
                let statsHtml = '';
                
                if (statsResponse.ok) {
                    const stats = await statsResponse.json();
                    statsHtml += `<div>Total Trades: ${stats.totalTrades}</div>`;
                    statsHtml += `<div>Active Wallets: ${stats.activeWallets}</div>`;
                }
                
                if (tradesResponse.ok) {
                    const trades = await tradesResponse.json();
                    statsHtml += `<div>Recent Trades: ${trades.length}</div>`;
                }
                
                if (eventsResponse.ok) {
                    const events = await eventsResponse.json();
                    statsHtml += `<div>System Events: ${events.length}</div>`;
                }
                
                document.getElementById('analyticsStats').innerHTML = statsHtml;
                
            } catch (error) {
                console.error('Error updating analytics stats:', error);
            }
        }

        async function resetAnalytics() {
            if (!confirm('üö® CLEAR ALL STATISTICS üö®\n\nThis will PERMANENTLY DELETE all trading history and analytics data.\n\nAre you sure you want to clear all stats?')) {
                return;
            }
            
            const confirmText = prompt('Type "CLEAR STATS" to confirm:');
            if (confirmText !== 'CLEAR STATS') {
                alert('Stats clear cancelled');
                return;
            }
            
            try {
                const response = await fetch('/api/analytics/reset', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    alert('All statistics cleared successfully');
                    await updateAnalyticsStats();
                    await refreshStats();
                    await loadEvents();
                } else {
                    const error = await response.json();
                    alert('Error: ' + error.detail);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function exportAnalytics() {
            alert('Export analytics feature coming soon');
        }

        async function clearSystemEvents() {
            if (!confirm('Clear all system events? This will remove the event history but keep trade data.')) {
                return;
            }
            
            try {
                const response = await fetch('/api/events/clear', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    alert('System events cleared');
                    await loadEvents();
                    await updateAnalyticsStats();
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // =============================================================================
        // UTILITY FUNCTIONS
        // =============================================================================
        function addOutput(message) {
            const output = document.getElementById('output');
            output.textContent += message + '\n';
            output.scrollTop = output.scrollHeight;
        }

        function startDataRefresh() {
            // Refresh data every 30 seconds
            setInterval(async () => {
                await refreshStats();
                await loadEvents();
            }, 30000);
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('addWalletModal');
            if (event.target === modal) {
                hideAddWalletModal();
            }
        }
    </script>
</body>
</html>
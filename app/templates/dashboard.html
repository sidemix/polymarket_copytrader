
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Bot Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: Arial, sans-serif;
    background: #1a1a1a;
    color: white;
    padding: 10px;
}
.container { max-width: 1400px; margin: 0 auto; }
.header { background: #2d2d2d; padding: 15px; border-radius: 10px; margin-bottom: 15px; display: flex; flex-direction: column; gap: 15px; }
.header-top { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
.header-controls { display: flex; align-items: center; flex-wrap: wrap; gap: 10px; }
.panel { background: #2d2d2d; padding: 15px; border-radius: 10px; margin-bottom: 15px; }
.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 15px; }
.stat { background: #3d3d3d; padding: 12px; border-radius: 8px; text-align: center; }
.stat-value { font-size: 20px; font-weight: bold; color: #4CAF50; }
.stat.negative .stat-value { color: #f44336; }
.btn {
    background: #4CAF50;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 5px;
    cursor: pointer;
    margin: 3px;
    font-size: 14px;
}
.btn.stop { background: #f44336; }
.btn.warning { background: #ff9800; }
.btn.small { padding: 4px 8px; font-size: 12px; }
.btn:disabled { background: #666; cursor: not-allowed; }
.wallet-list { max-height: 300px; overflow-y: auto; }
.wallet-item {
    background: #3d3d3d; padding: 12px; margin: 4px 0;
    border-radius: 5px; display: flex; justify-content: space-between;
    align-items: center; flex-wrap: wrap; gap: 8px;
}
.wallet-actions { display: flex; gap: 8px; flex-wrap: wrap; }
.wallet-profit { color: #4CAF50; }
.wallet-loss { color: #f44336; }
.wallet-paused { opacity: 0.6; }
textarea, input, select {
    width: 100%; padding: 8px; margin: 4px 0; background: #3d3d3d;
    border: 1px solid #555; color: white; border-radius: 5px; font-size: 14px;
}
#output {
    background: #1a1a1a; padding: 8px; border-radius: 5px;
    height: 150px; overflow-y: auto; font-family: monospace;
    font-size: 11px; white-space: pre-wrap;
}
.icon { display: inline-block; margin-right: 6px; }
.settings-grid { display: grid; grid-template-columns: 1fr; gap: 12px; margin-top: 12px; }
.wallet-stats { font-size: 11px; color: #ccc; margin-top: 4px; }
.tab-container {
    display: flex; margin-bottom: 15px; background: #2d2d2d;
    border-radius: 10px; padding: 4px; flex-wrap: wrap;
}
.tab {
    padding: 10px 15px; cursor: pointer; border-radius: 5px;
    flex: 1; text-align: center; transition: background 0.3s;
    border: none; background: transparent; color: white; font-size: 13px;
    min-width: 120px;
}
.tab:hover { background: #3d3d3d; }
.tab.active { background: #4CAF50; }
.tab-content { display: none; }
.tab-content.active { display: block; }
.wallet-address { font-family: monospace; font-size: 10px; color: #888; }
.wallet-nickname { font-weight: bold; color: #fff; font-size: 14px; }
.modal {
    display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.8); z-index: 1000;
    align-items: center; justify-content: center; padding: 20px;
}
.modal-content {
    background: #2d2d2d; padding: 20px; border-radius: 10px;
    width: 100%; max-width: 400px;
}
.notification-bell {
    position: relative; cursor: pointer;
    padding: 8px; background: #3d3d3d;
    border-radius: 50%; width: 40px; height: 40px;
    display: flex; align-items: center; justify-content: center;
}
.notification-badge {
    position: absolute; top: -5px; right: -5px;
    background: #f44336; color: white; border-radius: 50%;
    width: 20px; height: 20px; font-size: 11px;
    display: flex; align-items: center; justify-content: center;
    font-weight: bold;
}
.notifications-panel {
    position: absolute; top: 100%; right: 0;
    background: #2d2d2d; border: 1px solid #444;
    border-radius: 8px; width: 350px; max-height: 500px;
    overflow-y: auto; z-index: 1000; display: none;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}
.notifications-header {
    padding: 15px; border-bottom: 1px solid #444;
    display: flex; justify-content: space-between; align-items: center;
}
.notifications-body { max-height: 400px; overflow-y: auto; }
.notification-item { padding: 12px 15px; border-bottom: 1px solid #444; transition: background 0.2s; }
.notification-item:hover { background: #3d3d3d; }
.notification-item:last-child { border-bottom: none; }
.notification-title { font-weight: bold; margin-bottom: 5px; color: #fff; }
.notification-message { font-size: 13px; color: #ccc; margin-bottom: 5px; }
.notification-time { font-size: 11px; color: #888; }
.notification-actions { margin-top: 8px; display: flex; gap: 10px; }
.btn-clear {
    background: transparent; border: 1px solid #666; color: #ccc;
    padding: 4px 8px; border-radius: 3px; font-size: 11px; cursor: pointer;
}
.btn-clear:hover { background: #444; }
.no-notifications { padding: 20px; text-align: center; color: #888; font-style: italic; }
@media (min-width: 768px) {
    body { padding: 20px; }
    .header { padding: 20px; flex-direction: row; }
    .header-top { flex-direction: row; }
    .panel { padding: 20px; }
    .stats-grid { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
    .wallet-item { padding: 15px; flex-wrap: nowrap; }
    .settings-grid { grid-template-columns: 1fr 1fr; }
}
.chart-container { background: #2d2d2d; padding: 15px; border-radius: 10px; margin-bottom: 15px; height: 300px; }
.charts-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
@media (min-width: 768px) { .charts-grid { grid-template-columns: 1fr 1fr; } }
.discovery-item {
    background: #3d3d3d; padding: 12px;
    margin: 5px 0; border-radius: 5px;
    display: flex; justify-content: space-between;
    align-items: center; flex-wrap: wrap; gap: 8px;
}
.discovery-stats { font-size: 11px; color: #ccc; }
    </style>
</head>
<body>
<div class="container">
<div class="header">
    <div class="header-top">
        <h1><i class="fas fa-robot fa-icon"></i> Trading Bot Dashboard</h1>
        <div class="header-controls">
            <div class="notification-bell" onclick="toggleNotifications()">
                <i class="fas fa-bell fa-icon"></i>
                <span class="notification-badge" id="notificationCount">{{ unread_notifications | default(0) }}</span>
                <div class="notifications-panel" id="notificationsPanel">
                    <div class="notifications-header">
                        <h3><i class="fas fa-bell fa-icon"></i> Notifications</h3>
                        <div>
                            <button class="btn-clear" onclick="clearAllNotifications()">Clear All</button>
                            <button class="btn-clear" onclick="markAllAsRead()">Mark Read</button>
                        </div>
                    </div>
                    <div class="notifications-body" id="notificationsList">
                        {% if notifications %}
                            {% for notif in notifications %}
                            <div class="notification-item {{ 'read' if notif.read else '' }}">
                                <div class="notification-title">
                                    <i class="fas fa-{{ get_notification_icon(notif.type) }} fa-icon"></i>
                                    {{ notif.title }}
                                </div>
                                <div class="notification-message">{{ notif.message }}</div>
                                <div class="notification-time">{{ notif.timestamp.strftime('%H:%M %d/%m') }}</div>
                                <div class="notification-actions">
                                    <button class="btn-clear" onclick="markAsRead({{ notif.id }})">
                                        {{ 'Read' if notif.read else 'Mark Read' }}
                                    </button>
                                    <button class="btn-clear" onclick="deleteNotification({{ notif.id }})">Delete</button>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="no-notifications">No notifications</div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <button id="startBtn" class="btn" onclick="controlBot('start')"><i class="fas fa-play"></i> Start</button>
            <button id="stopBtn" class="btn stop" onclick="controlBot('stop')" {% if bot_status == 'RUNNING' %}disabled{% endif %}><i class="fas fa-stop"></i> Stop</button>
            <span id="status">Status: {{ bot_status | title }}</span>
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        </div>
    </div>
</div>
<!-- TABS -->
<div class="tab-container">
    <button class="tab active" data-tab="overview"><i class="fas fa-chart-bar fa-icon"></i> Overview</button>
    <button class="tab" data-tab="analytics"><i class="fas fa-chart-line fa-icon"></i> Analytics</button>
    <button class="tab" data-tab="wallets"><i class="fas fa-wallet fa-icon"></i> Wallets</button>
    <button class="tab" data-tab="discovery"><i class="fas fa-search fa-icon"></i> Discovery</button>
    <button class="tab" data-tab="risk"><i class="fas fa-shield-alt fa-icon"></i> Risk</button>
    <button class="tab" data-tab="settings"><i class="fas fa-cog fa-icon"></i> Settings</button>
</div>
<!-- OVERVIEW TAB -->
<div id="overview-tab" class="tab-content active">
    <div class="panel">
        <h3><i class="fas fa-chart-bar fa-icon"></i> Performance Stats</h3>
        <div class="stats-grid">
            <div class="stat"><div class="stat-value" id="totalTrades">{{ stats.total_trades | default(0) }}</div><div>Total Trades</div></div>
            <div class="stat"><div class="stat-value" id="profitableTrades">{{ stats.profitable_trades | default(0) }}</div><div>Profitable Trades</div></div>
            <div class="stat {% if stats.total_pnl < 0 %}negative{% endif %}"><div class="stat-value" id="totalProfit">${{ "%.2f"|format(stats.total_pnl | default(0)) }}</div><div>Total Profit</div></div>
            <div class="stat"><div class="stat-value" id="winRate">{{ "%.1f"|format(stats.win_rate | default(0)) }}%</div><div>Win Rate</div></div>
            <div class="stat"><div class="stat-value" id="activeWallets">{{ stats.active_wallets | default(0) }}</div><div>Active Wallets</div></div>
            <div class="stat"><div class="stat-value" id="riskLevel">{{ risk_level | default('Low') }}</div><div>Risk Level</div></div>
        </div>
    </div>
    <div class="charts-grid">
        <div class="panel">
            <h3><i class="fas fa-trophy fa-icon"></i> Top Performing Wallets</h3>
            <div class="wallet-list" id="topWallets">
                {% if top_wallets %}
                    {% for wallet in top_wallets %}
                    <div class="wallet-item">
                        <div>
                            <div class="wallet-nickname">{{ wallet.nickname }}</div>
                            <div class="wallet-address">{{ wallet.address[:6] }}...{{ wallet.address[-4:] }}</div>
                            <div class="wallet-stats">ROI: {{ "%.2f"|format(wallet.roi) }}% | Trades: {{ wallet.trade_count }}</div>
                        </div>
                        <div class="wallet-profit">+${{ "%.2f"|format(wallet.pnl) }}</div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="wallet-item">No wallets yet — add one!</div>
                {% endif %}
            </div>
        </div>
        <div class="panel">
            <h3><i class="fas fa-list fa-icon"></i> Recent Activity</h3>
            <div id="output">{{ recent_activity | default('Waiting for bot output...') }}</div>
        </div>
    </div>
</div>
<!-- ANALYTICS TAB -->
<div id="analytics-tab" class="tab-content">
    <div class="panel">
        <h3><i class="fas fa-chart-line fa-icon"></i> Performance Analytics</h3>
        <div class="charts-grid">
            <div class="chart-container"><canvas id="profitChart"></canvas></div>
            <div class="chart-container"><canvas id="tradesChart"></canvas></div>
        </div>
        <div class="charts-grid">
            <div class="chart-container"><canvas id="walletPerformanceChart"></canvas></div>
            <div class="chart-container"><canvas id="winRateChart"></canvas></div>
        </div>
    </div>
</div>
<!-- WALLETS TAB -->
<div id="wallets-tab" class="tab-content">
    <div class="charts-grid">
        <div class="panel">
            <h3><i class="fas fa-wallet fa-icon"></i> Wallet Management</h3>
            <div style="margin-bottom: 15px;">
                <button class="btn" onclick="showAddWalletModal()"><i class="fas fa-plus"></i> Add Wallet</button>
            </div>
            <div id="walletsList">
                {% if wallets %}
                    {% for wallet in wallets %}
                    <div class="wallet-item">
                        <div>
                            <div class="wallet-nickname">{{ wallet.nickname }}</div>
                            <div class="wallet-address">{{ wallet.address }}</div>
                            <div class="wallet-stats">Status: {{ 'Active' if wallet.is_active else 'Paused' }}</div>
                        </div>
                        <div class="wallet-actions">
                            <button class="btn small" onclick="toggleWallet({{ wallet.id }})">{{ 'Pause' if wallet.is_active else 'Activate' }}</button>
                            <button class="btn small stop" onclick="removeWallet({{ wallet.id }})">Remove</button>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="wallet-item">No wallets — add one to start copying!</div>
                {% endif %}
            </div>
        </div>
        <div class="panel">
            <h3><i class="fas fa-chart-line fa-icon"></i> Wallet Performance</h3>
            <div class="wallet-list" id="walletPerformance">
                <!-- Dynamic via JS or load from backend -->
            </div>
        </div>
    </div>
</div>
<!-- DISCOVERY TAB -->
<div id="discovery-tab" class="tab-content">
    <div class="panel">
        <h3><i class="fas fa-search fa-icon"></i> Auto Wallet Discovery</h3>
        <div style="margin-bottom: 15px;">
            <button class="btn" onclick="discoverWallets()"><i class="fas fa-search"></i> Find Profitable Wallets</button>
            <button class="btn warning" onclick="stopDiscovery()"><i class="fas fa-stop"></i> Stop Discovery</button>
        </div>
        <div id="discoveryResults">
            <div class="discovery-item">Click "Find Profitable Wallets" to discover new trading opportunities</div>
            {% if discovered_wallets %}
                {% for wallet in discovered_wallets %}
                <div class="discovery-item">
                    <div>
                        <div class="wallet-nickname">{{ wallet.nickname }}</div>
                        <div class="discovery-stats">ROI: {{ "%.2f"|format(wallet.roi) }}% | Volume: ${{ "%.0f"|format(wallet.volume) }}</div>
                    </div>
                    <button class="btn small" onclick="addDiscoveredWallet('{{ wallet.address }}')">Add</button>
                </div>
                {% endfor %}
            {% endif %}
        </div>
    </div>
</div>
<!-- RISK TAB -->
<div id="risk-tab" class="tab-content">
    <div class="charts-grid">
        <div class="panel">
            <h3><i class="fas fa-shield-alt fa-icon"></i> Risk Controls</h3>
            <form method="POST" action="/api/risk/update">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div style="margin-bottom: 15px;">
                    <label><i class="fas fa-percentage fa-icon"></i> Copy Trading Percentage:</label>
                    <input type="range" id="copyPercentage" name="copy_percentage" min="1" max="100" value="{{ settings.copy_percentage | default(20) }}">
                    <span id="copyPercentageValue">{{ settings.copy_percentage | default(20) }}%</span>
                </div>
                <div style="margin-bottom: 15px;">
                    <label><i class="fas fa-dollar-sign fa-icon"></i> Max Trade Amount ($):</label>
                    <input type="number" id="maxTradeAmount" name="max_trade_usd" value="{{ settings.max_trade_usd | default(100) }}">
                </div>
                <div style="margin-bottom: 15px;">
                    <label><i class="fas fa-exclamation-triangle fa-icon"></i> Daily Loss Limit ($):</label>
                    <input type="number" id="dailyLossLimit" name="daily_loss_limit" value="{{ settings.daily_loss_limit | default(200) }}">
                </div>
                <div style="margin-bottom: 15px;">
                    <label><i class="fas fa-clock fa-icon"></i> Max Trades Per Hour:</label>
                    <input type="number" id="maxTradesPerHour" name="max_trades_per_hour" value="{{ settings.max_trades_per_hour | default(10) }}">
                </div>
                <button type="submit" class="btn"><i class="fas fa-save"></i> Update Risk Settings</button>
            </form>
        </div>
        <div class="panel">
            <h3><i class="fas fa-balance-scale fa-icon"></i> Balance Management</h3>
            <form method="POST" action="/api/balance/update">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div style="margin-bottom: 15px;">
                    <label>Available Cash:</label>
                    <input type="number" id="cashInput" name="available_cash" value="{{ balances.available_cash | default(5920) }}">
                </div>
                <div style="margin-bottom: 15px;">
                    <label>Portfolio Value:</label>
                    <input type="number" id="portfolioInput" name="portfolio_value" value="{{ balances.portfolio_value | default(10019) }}">
                </div>
                <div style="margin-bottom: 15px;">
                    <label>Risk Tolerance:</label>
                    <select id="riskTolerance" name="risk_tolerance">
                        <option value="low" {% if risk_tolerance == 'low' %}selected{% endif %}>Low (Conservative)</option>
                        <option value="medium" {% if risk_tolerance == 'medium' %}selected{% endif %}>Medium (Balanced)</option>
                        <option value="high" {% if risk_tolerance == 'high' %}selected{% endif %}>High (Aggressive)</option>
                    </select>
                </div>
                <button type="submit" class="btn"><i class="fas fa-save"></i> Update Balance</button>
            </form>
            <div style="margin-top: 20px; padding: 15px; background: #3d3d3d; border-radius: 5px;">
                <h4><i class="fas fa-info-circle fa-icon"></i> Risk Status</h4>
                <div id="riskStatus">{{ risk_status | default('All systems normal') }}</div>
                <div class="wallet-stats" id="riskStats">Daily P&L: ${{ "%.2f"|format(daily_pnl | default(0)) }} | Trades Today: {{ trades_today | default(0) }}</div>
            </div>
        </div>
    </div>
</div>
<!-- SETTINGS TAB -->
<div id="settings-tab" class="tab-content">
    <div class="panel">
        <h3><i class="fas fa-cog fa-icon"></i> Bot Configuration</h3>
        <form method="POST" action="/api/settings/update">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="settings-grid">
                <div>
                    <label>Minimum Trade Amount ($):</label>
                    <input type="number" id="minTradeAmount" name="min_trade_amount" value="{{ settings.min_trade_amount | default(5) }}">
                </div>
                <div>
                    <label>Cooldown Between Trades (seconds):</label>
                    <input type="number" id="tradeCooldown" name="trade_cooldown" value="{{ settings.trade_cooldown | default(30) }}">
                </div>
                <div>
                    <label>Auto-stop on Daily Loss:</label>
                    <select id="autoStopEnabled" name="auto_stop_enabled">
                        <option value="true" {% if settings.auto_stop_enabled %}selected{% endif %}>Enabled</option>
                        <option value="false" {% if not settings.auto_stop_enabled %}selected{% endif %}>Disabled</option>
                    </select>
                </div>
                <div>
                    <label>Push Notifications:</label>
                    <select id="pushNotifications" name="push_notifications">
                        <option value="true" {% if settings.push_notifications %}selected{% endif %}>Enabled</option>
                        <option value="false" {% if not settings.push_notifications %}selected{% endif %}>Disabled</option>
                    </select>
                </div>
            </div>
            <button type="submit" class="btn" style="margin-top: 15px;">
                <i class="fas fa-save"></i> Update Bot Settings
            </button>
        </form>
    </div>
</div>
</div> <!-- end container -->
<!-- ADD WALLET MODAL -->
<div id="addWalletModal" class="modal">
    <div class="modal-content">
        <h3><i class="fas fa-plus fa-icon"></i> Add Wallet</h3>
        <form method="POST" action="/api/wallets/add">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="wallet-input-row">
                <input type="text" id="walletNickname" name="nickname" placeholder="Nickname">
            </div>
            <div class="wallet-input-row">
                <input type="text" id="walletAddress" name="address" placeholder="Wallet Address">
            </div>
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button type="submit" class="btn"><i class="fas fa-save"></i> Add Wallet</button>
                <button type="button" class="btn stop" onclick="hideAddWalletModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>
<script src="/socket.io/socket.io.js"></script>
<script>
let authToken = localStorage.getItem('authToken');
if (!authToken) { window.location.href = '/login'; }
let notifications = {{ notifications | tojson | safe }};
let unreadCount = {{ unread_notifications | default(0) }};

// Your original notification functions (addNotification, updateNotificationsList, etc.) — unchanged
function updateNotificationCount() {
    document.getElementById('notificationCount').textContent = unreadCount;
    localStorage.setItem('unreadNotificationCount', unreadCount.toString());
    localStorage.setItem('botNotifications', JSON.stringify(notifications));
}
function addNotification(title, message, type='info') {
    const notification = {
        id: Date.now(),
        title, message, type,
        timestamp: new Date(),
        read: false
    };
    notifications.unshift(notification);
    unreadCount++;
    if (notifications.length > 50) notifications = notifications.slice(0, 50);
    updateNotificationCount();
    updateNotificationsList();
}
// ... (all other functions like getNotificationIcon, formatTime, markAsRead, etc. — copy from original)

updateNotificationCount();
updateNotificationsList();

/* SOCKET.IO EVENTS — with auth */
const socket = io({ auth: { token: authToken } });
socket.on('connect', () => console.log('Connected to bot events'));
socket.on('trade_executed', trade => {
    addNotification('Trade Executed',
        `${trade.walletNickname || trade.wallet.substring(0, 10)}: ${trade.side} $${trade.amount}`,
        'trade'
    );
    // Update stats via API or emit
});
socket.on('risk_alert', alert => {
    addNotification('Risk Alert', alert.message, 'warning');
});
socket.on('bot_output', output => {
    const outputDiv = document.getElementById('output');
    outputDiv.textContent += output + '\n';
    outputDiv.scrollTop = outputDiv.scrollHeight;
    if (output.includes('TRADE OPPORTUNITY') || output.includes('DAILY LOSS LIMIT')) {
        addNotification('Bot Activity', output.trim(), 'info');
    }
});

/* Bot Controls — POST to API with CSRF */
function controlBot(action) {
    fetch(`/api/bot/${action}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ csrf_token: '{{ csrf_token() }}' })
    }).then(res => res.json()).then(data => {
        if (data.success) {
            document.getElementById('status').textContent = `Status: ${action.toUpperCase()}`;
            addNotification('Bot Control', `Bot ${action}ed`, 'success');
        }
    });
}
// Add wallet modal
function showAddWalletModal() {
    document.getElementById('addWalletModal').style.display = 'flex';
}
function hideAddWalletModal() {
    document.getElementById('addWalletModal').style.display = 'none';
}
// ... (other JS: setupTabs, initializeCharts, loadData, etc. — from original)

document.addEventListener('DOMContentLoaded', function() {
    setupTabs();
    initializeCharts();
    requestNotificationPermission();
    loadData();  // Fetch dynamic data via fetch('/api/stats')
    updateNotificationCount();
});
</script>
</body>
</html>
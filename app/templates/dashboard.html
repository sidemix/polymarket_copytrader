<!DOCTYPE html>
<html lang="en">
<head>
    <!-- ============================================================================= -->
    <!-- HEAD SECTION - META, STYLES, AND IMPORTS -->
    <!-- ============================================================================= -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Bot Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        /* ============================================================================= */
        /* CSS STYLES - DASHBOARD STYLING */
        /* ============================================================================= */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #1a1a1a; color: white; padding: 10px; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { background: #2d2d2d; padding: 15px; border-radius: 10px; margin-bottom: 15px; }
        .panel { background: #2d2d2d; padding: 15px; border-radius: 10px; margin-bottom: 15px; }
        .btn { background: #4CAF50; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; margin: 3px; }
        .btn.stop { background: #f44336; }
        .btn.warning { background: #ff9800; }
        .mode-test { color: #ff9800; }
        .mode-live { color: #4CAF50; }
        /* Add more styles as needed */
    </style>
</head>
<body>
    <!-- ============================================================================= -->
    <!-- HEADER SECTION - BOT CONTROLS AND STATUS -->
    <!-- ============================================================================= -->
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-robot"></i> Trading Bot Dashboard</h1>
            <div>
                <button class="btn" onclick="controlBot('start')">Start</button>
                <button class="btn stop" onclick="controlBot('stop')">Stop</button>
                <span id="status">Status: <span id="statusText">STOPPED</span></span>
                <span id="mode">Mode: <span class="mode-test" id="modeText">TEST</span></span>
                <span id="dryRun" style="color: #ff9800;">DRY RUN</span>
            </div>
        </div>

        <!-- ============================================================================= -->
        <!-- TAB NAVIGATION -->
        <!-- ============================================================================= -->
        <div class="tab-container">
            <button class="tab active" data-tab="overview">Overview</button>
            <button class="tab" data-tab="analytics">Analytics</button>
            <button class="tab" data-tab="wallets">Wallets</button>
            <button class="tab" data-tab="settings">Settings</button>
        </div>

        <!-- ============================================================================= -->
        <!-- OVERVIEW TAB CONTENT -->
        <!-- ============================================================================= -->
        <div id="overview-tab" class="tab-content active">
            <div class="panel">
                <h3>Performance Stats</h3>
                <div class="stats-grid">
                    <div class="stat"><div id="totalTrades">0</div><div>Total Trades</div></div>
                    <div class="stat"><div id="winRate">0%</div><div>Win Rate</div></div>
                </div>
            </div>
        </div>

        <!-- ============================================================================= -->
        <!-- SETTINGS TAB CONTENT - MODE MANAGEMENT -->
        <!-- ============================================================================= -->
        <div id="settings-tab" class="tab-content">
            <div class="panel">
                <h3>Trading Mode Management</h3>
                <div id="modeInfo">
                    <!-- Mode information will be loaded here -->
                </div>

                <div class="settings-grid">
                    <div>
                        <label>Trading Mode:</label>
                        <select id="tradingMode">
                            <option value="TEST">TEST</option>
                            <option value="LIVE">LIVE</option>
                        </select>
                    </div>
                    <div>
                        <label>Dry Run Mode:</label>
                        <select id="dryRunEnabled">
                            <option value="true">Enabled</option>
                            <option value="false">Disabled</option>
                        </select>
                    </div>
                </div>

                <!-- ============================================================================= -->
                <!-- QUICK ACTIONS SECTION - MODE SWITCHING AND STATS CLEARING -->
                <!-- ============================================================================= -->
                <div class="quick-actions">
                    <h4>Quick Actions</h4>
                    <button class="btn warning" onclick="resetAnalytics()">
                        <i class="fas fa-trash"></i> Clear All Stats
                    </button>
                    <button class="btn" onclick="quickSwitchMode()">
                        <i class="fas fa-exchange-alt"></i> Switch Mode
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================================================= -->
    <!-- JAVASCRIPT SECTION - DASHBOARD FUNCTIONALITY -->
    <!-- ============================================================================= -->
    <script>
        // =============================================================================
        // GLOBAL STATE AND INITIALIZATION
        // =============================================================================
        let socket = null;
        let currentSettings = {};

        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeSocket();
            setupTabs();
            loadInitialData();
        });

        // =============================================================================
        // SOCKET.IO COMMUNICATION
        // =============================================================================
        function initializeSocket() {
            socket = io();
            socket.on('connect', function() {
                console.log('Socket connected');
            });
            socket.on('status_update', function(data) {
                updateBotStatus(data.status);
            });
            socket.on('mode_update', function(data) {
                loadSettings(); // Refresh settings when mode changes
            });
        }

        // =============================================================================
        // DATA LOADING FUNCTIONS
        // =============================================================================
        async function loadInitialData() {
            await Promise.all([
                loadSettings(),
                refreshStats()
            ]);
        }

        async function loadSettings() {
            try {
                const response = await fetch('/api/settings');
                if (response.ok) {
                    currentSettings = await response.json();
                    updateSettingsDisplay();
                    updateModeDisplay(currentSettings);
                    updateHeaderDisplay();
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        // =============================================================================
        // BOT CONTROL FUNCTIONS
        // =============================================================================
        async function controlBot(action) {
            try {
                const response = await fetch(`/api/bot/${action}`, {method: 'POST'});
                const result = await response.json();
                alert(result.message);
                await loadSettings();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // =============================================================================
        // MODE MANAGEMENT FUNCTIONS
        // =============================================================================
        async function switchTradingMode(newMode) {
            const resetAnalytics = confirm(`Switch to ${newMode} mode? This will ${newMode === 'LIVE' ? 'reset analytics and ' : ''}stop the bot.`);
            
            try {
                const response = await fetch('/api/settings/switch-mode', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({mode: newMode, reset_analytics: resetAnalytics})
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(result.message);
                    await loadSettings();
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        function quickSwitchMode() {
            if (!currentSettings) return;
            const newMode = currentSettings.global_trading_mode === 'TEST' ? 'LIVE' : 'TEST';
            switchTradingMode(newMode);
        }

        // =============================================================================
        // ANALYTICS MANAGEMENT FUNCTIONS
        // =============================================================================
        async function resetAnalytics() {
            if (!confirm('Clear all statistics? This cannot be undone.')) return;
            
            try {
                const response = await fetch('/api/analytics/reset', {method: 'POST'});
                const result = await response.json();
                alert(result.message);
                await refreshStats();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // =============================================================================
        // UI UPDATE FUNCTIONS
        // =============================================================================
        function updateHeaderDisplay() {
            const modeText = document.getElementById('modeText');
            const dryRunElement = document.getElementById('dryRun');
            
            if (currentSettings) {
                modeText.textContent = currentSettings.global_trading_mode;
                modeText.className = `mode-${currentSettings.global_trading_mode.toLowerCase()}`;
                
                if (currentSettings.dry_run_enabled) {
                    dryRunElement.style.display = 'inline';
                } else {
                    dryRunElement.style.display = 'none';
                }
            }
        }

        function updateModeDisplay(settings) {
            const modeInfo = document.getElementById('modeInfo');
            const modeText = settings.global_trading_mode === 'LIVE' ? 
                `<span class="mode-live">LIVE</span>` : 
                `<span class="mode-test">TEST</span>`;
            
            modeInfo.innerHTML = `
                <div>
                    <h4>Current Mode: ${modeText}</h4>
                    <button class="btn" onclick="switchTradingMode('${settings.global_trading_mode === 'TEST' ? 'LIVE' : 'TEST'}')">
                        Switch to ${settings.global_trading_mode === 'TEST' ? 'LIVE' : 'TEST'}
                    </button>
                </div>
            `;
        }

        // =============================================================================
        // UTILITY FUNCTIONS
        // =============================================================================
        function setupTabs() {
            // Tab switching logic
        }

        async function refreshStats() {
            // Refresh statistics
        }

        function updateSettingsDisplay() {
            // Update settings form fields
        }
    </script>
</body>
</html>